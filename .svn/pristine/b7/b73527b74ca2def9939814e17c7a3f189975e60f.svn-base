{"version":3,"sources":["file:///G:/Work/cocoscreator/MiniGame/assets/script/game/gameGrid/view/GameGridStartView.ts"],"names":["MapGridItem","BtnPreviewGrid","_decorator","Component","EventManager","EventEnum","ccclass","property","GameGridStartView","_previewGrid1","_previewGrid2","_previewGrid3","_txtScore","_mapItemList","_mapContainer","_rightCount","_score","update","dt","start","console","log","GameUI","FindChild","entity","gridIndex","engine","UILabel","text","btnExit","UIButton","self","onClick","add","uploadScore","exitClear","dispatch","OnGameExit","GameType","Grid","initMapGrid","addListener","OnGameGridTouchEnd","OnTouchEndCheck","OnGameGridReqNextPreview","OnReqNextPreview","wx","cloud","init","db","database","rankData","collection","openDataContext","getOpenDataContext","userStorage","getUserCloudStorage","score","setUserCloudStorage","KVDataList","key","value","JSON","stringify","wxgame","String","update_time","Date","success","showToast","title","icon","duration","fail","res","row","col","item","updatePreviewGrid","index","gridList","num","length","emptyNum","itemArr","i","grid","localPos","transform2D","convertWorldPositionToLocal","worldPosition","x","y","idx","ConvertXYToIndex","isEmpty","push","checkListX","checkListY","setEmpty","indexOf","UpdateTouchEndResult","splice","canRemove","lenX","lenY","Mgr","soundMgr","play","posX","posY","Math","round","abs","OnGameStart","active","k","_col","_row","_posX","_posY","_itemEntity","_container","_posArr","_isEmpty","_playTween","consturctor","container","initUI","url","prefabAsset","loader","getAsset","instantiate","addChild","positionX","positionY","bool","playTween","col_row","clearTween","TweenManager","addTween","wait","to","scaleX","scaleY","removeTweens","position","getItemWorldPos","_touchMask","_preview","_previewX","_previewY","_moveStartX","_moveStartY","_offsetX","_offsetY","_canMove","_gridIndex","_randomGrid","_lastRandomGrid","_gridList","_btnGrid","onAwake","onUpdate","onDestroy","onTouchCancel","touchEnd","onTouchUp","onTouchStart","target","event","touches","touchStart","onTouchMove","touchMove","startX","startY","moveX","moveY","offsetX","offsetY","isRight","itemList","call","gridIdx","random","updatePreview","load","promise","then","destroyImmediate","childrenCount","rotation","PI"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node } from 'cc';\r\nimport { EventManager } from '../../../manager/EventManager';\r\nimport { EventEnum } from '../../../enum/EventEnum';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameGridStartView')\r\nexport class GameGridStartView extends Component {\r\n    private _previewGrid1:BtnPreviewGrid;\r\n    private _previewGrid2:BtnPreviewGrid;\r\n    private _previewGrid3:BtnPreviewGrid;\r\n\r\n    private _txtScore:engine.UILabel;\r\n\r\n    private _mapItemList:MapGridItem[][];\r\n    private _mapContainer:engine.Entity;\r\n    private _rightCount:number = 0;\r\n    private _score:number = 0;\r\n    public update(dt) {\r\n\r\n    }\r\n    public start(): void {\r\n        console.log(\"onGameGridStart\");\r\n        this._mapContainer = GameUI.FindChild(this.entity,\"gridMap/items\");\r\n\r\n        this._previewGrid1 = GameUI.FindChild(this.entity,\"BtnPreviewGrid1\",BtnPreviewGrid);\r\n        this._previewGrid1.gridIndex = 1;\r\n        this._previewGrid2 = GameUI.FindChild(this.entity,\"BtnPreviewGrid2\",BtnPreviewGrid);\r\n        this._previewGrid2.gridIndex = 2;\r\n        this._previewGrid3 = GameUI.FindChild(this.entity,\"BtnPreviewGrid3\",BtnPreviewGrid);\r\n        this._previewGrid3.gridIndex = 3;\r\n\r\n        this._txtScore = GameUI.FindChild(this.entity,\"txtScore\",engine.UILabel);\r\n        this._txtScore.text = \"0\";\r\n\r\n        let btnExit:engine.UIButton = GameUI.FindChild(this.entity,\"btnExit\",engine.UIButton);\r\n        let self = this\r\n        btnExit.onClick.add(function(){\r\n            //退出前回到初始化状态\r\n            self.uploadScore();\r\n            self.exitClear();\r\n            EventManager.dispatch(EventEnum.OnGameExit,GameType.Grid);\r\n        });\r\n\r\n        this.initMapGrid();\r\n        EventManager.addListener(EventEnum.OnGameGridTouchEnd,this.OnTouchEndCheck,this);\r\n        EventManager.addListener(EventEnum.OnGameGridReqNextPreview,this.OnReqNextPreview,this);\r\n    }\r\n\r\n    private uploadScore(){\r\n        wx.cloud.init();\r\n        let db = wx.cloud.database()\r\n        let rankData = db.collection('gamegrid_rank');\r\n        console.log(\"获取排行榜数据\",rankData);\r\n        let openDataContext = wx.getOpenDataContext();\r\n        let userStorage = wx.getUserCloudStorage()\r\n        console.log(\"获取用户托管数据\",userStorage);\r\n        const score = this._score;//Math.floor(Math.random() * 100)\r\n        wx.setUserCloudStorage({\r\n        KVDataList: [\r\n            {\r\n                key: 'rankid',\r\n                value: JSON.stringify({\r\n                    wxgame: {\r\n                    score: String(score),\r\n                    update_time: String(+ new Date() / 1000)\r\n                    }\r\n                })\r\n            },\r\n        ],\r\n        success: () => {\r\n            wx.showToast({\r\n                title: `分数上报成功: ${score}分`,\r\n                icon: 'none',\r\n                duration: 2000\r\n            })\r\n            console.log('上传成功')\r\n        },\r\n        fail: (res) => {\r\n            console.log(res)\r\n        }\r\n    })\r\n    }\r\n\r\n    private initMapGrid(){\r\n        this._mapItemList = [];\r\n        for(let row = 0; row < 10; row++){\r\n            for(let col = 0; col < 10; col++){\r\n                if(!this._mapItemList[row]){\r\n                    this._mapItemList[row] = [];\r\n                }\r\n                let item:MapGridItem = new MapGridItem();\r\n                this._mapItemList[row][col] = item;\r\n                item.init(col,row,this._mapContainer);\r\n            }\r\n        }\r\n    }\r\n\r\n    private OnReqNextPreview(){\r\n        this._previewGrid1.updatePreviewGrid();\r\n        this._previewGrid2.updatePreviewGrid();\r\n        this._previewGrid3.updatePreviewGrid();\r\n    }\r\n\r\n    private OnTouchEndCheck(index:number,gridList:engine.Entity[]){\r\n        let num = gridList.length;\r\n        let emptyNum = 0;\r\n        let itemArr:MapGridItem[] = [];\r\n        for(let i = 0; i < num; i ++) {\r\n            let grid:engine.Entity = gridList[i];//GameUI.FindChild(randomGrid,\"grid\" + i);\r\n            let localPos:engine.Vector2 = this._mapContainer.transform2D.convertWorldPositionToLocal(grid.transform2D.worldPosition);\r\n            // console.log(\"坐标转换\" + i + \"----x：\" + localPos.x + \"----y：\" + localPos.y)\r\n            if(localPos.x >= -500 && localPos.x <= 500 && localPos.y >= -500 && localPos.y <= 500){\r\n                //在范围内，进一步检测对应网格是否是空位\r\n                let idx:number[] = this.ConvertXYToIndex(localPos.x,localPos.y);\r\n                // console.log(\"坐标转换行列值\" + i + \"----col：\" + idx[0] + \"----row：\" + idx[1]);\r\n                let item:MapGridItem = this._mapItemList[idx[1]][idx[0]];\r\n                if(item.isEmpty){\r\n                    emptyNum ++;\r\n                    itemArr.push(item);\r\n                }else{\r\n                    //存在非空网格\r\n                    break;\r\n                }\r\n            }\r\n            else{\r\n                //不在网格地图范围内\r\n                break;\r\n            }\r\n        }\r\n\r\n        let checkListX:number[] = [];\r\n        let checkListY:number[] = [];\r\n        if(emptyNum == num){\r\n            for(let i = 0; i < itemArr.length; i ++){\r\n                itemArr[i].setEmpty(false);\r\n                let col:number = itemArr[i].col;\r\n                let row:number = itemArr[i].row;\r\n                if(checkListX.indexOf(col) == -1){\r\n                    checkListX.push(col);\r\n                }\r\n                if(checkListY.indexOf(row) == -1){\r\n                    checkListY.push(row);\r\n                }\r\n            }\r\n            this._rightCount ++;\r\n        }\r\n        this[\"_previewGrid\" + index].UpdateTouchEndResult(emptyNum == num,itemArr);\r\n        if(this._rightCount >= 3){\r\n            this._rightCount = 0;\r\n            this.OnReqNextPreview();\r\n        }\r\n\r\n        for(let i:number = checkListX.length - 1; i >= 0; i--){\r\n            let col:number = checkListX[i];\r\n            for(let row:number = 0; row < 10; row++){\r\n                if(this._mapItemList[row][col].isEmpty){\r\n                    checkListX.splice(i,1);\r\n                    break; \r\n                }\r\n            }\r\n        }\r\n        for(let i:number = checkListY.length - 1; i >= 0 ; i--){\r\n            let row:number = checkListY[i];\r\n            for(let col:number = 0; col < 10; col++){\r\n                if(this._mapItemList[row][col].isEmpty){\r\n                    checkListY.splice(i,1);\r\n                    break; \r\n                }\r\n            }\r\n        }\r\n        let canRemove:boolean = false;\r\n        let lenX:number = checkListX.length;\r\n        let lenY:number = checkListY.length;\r\n        for(let i:number = 0; i < lenX; i++){\r\n            let col:number = checkListX[i];\r\n            for(let row:number = 0; row < 10; row++){\r\n                this._mapItemList[row][col].setEmpty(true,true,1);//1、纵向消除\r\n                canRemove = true\r\n            }\r\n        }\r\n        for(let i:number = 0; i < lenY ; i++){\r\n            let row:number = checkListY[i];\r\n            for(let col:number = 0; col < 10; col++){\r\n                this._mapItemList[row][col].setEmpty(true,true,2);//2、横向消除\r\n                canRemove = true\r\n            }\r\n        }\r\n        this._score += (lenX + lenY);\r\n        this._txtScore.text = this._score + \"\";\r\n        if(canRemove) Mgr.soundMgr.play(\"crrect_answer3\");//存在可消除的行or列\r\n    }\r\n\r\n    //局部坐标转换为网格索引\r\n    private ConvertXYToIndex(posX:number,posY:number):number[]{\r\n        let col = Math.round((posX + 450) / 100);\r\n        let row = Math.round(Math.abs(posY - 450) / 100);\r\n        return [col,row];\r\n    }\r\n\r\n    public OnGameStart(){\r\n        this._score = 0;\r\n        this._txtScore.text = \"0\";\r\n        this.OnReqNextPreview();\r\n    }\r\n    private exitClear(){\r\n        this._rightCount = 0;\r\n        this.entity.active = false;\r\n        this._txtScore.text = \"0\";\r\n        this._score = 0;\r\n        for(let i:number = 0; i < this._mapItemList.length; i++){\r\n            for(let k:number = 0; k < this._mapItemList[i].length; k++){\r\n                this._mapItemList[i][k].setEmpty(true);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport class MapGridItem {\r\n    private _col:number;\r\n    private _row:number;\r\n    private _posX:number;\r\n    private _posY:number;\r\n    private _itemEntity:engine.Entity;\r\n    private _container:engine.Entity;\r\n    private _posArr:number[];\r\n\r\n    private _isEmpty:boolean = true;\r\n    private _playTween:boolean;\r\n    public consturctor(){\r\n\r\n    }\r\n\r\n    public init(col:number,row:number,container:engine.Entity){\r\n        this._col = col;\r\n        this._row = row;\r\n        this._posX = -450 + col * 100;\r\n        this._posY = 450 - row * 100;\r\n        this._posArr = [this._posX,this._posY];\r\n        this._container = container;\r\n    }\r\n\r\n    private initUI(){\r\n        let url:string = \"Resources/Prefabs/GameGridMapItem.prefab\";\r\n        let prefabAsset:engine.Prefab = engine.loader.getAsset(url);\r\n        if(prefabAsset){\r\n            this._itemEntity = prefabAsset.instantiate();\r\n            this._container.transform2D.addChild(this._itemEntity.transform2D);\r\n            this._itemEntity.transform2D.positionX = this._posX;\r\n            this._itemEntity.transform2D.positionY = this._posY;\r\n        }\r\n    }\r\n\r\n    public get isEmpty():boolean{\r\n        return this._isEmpty;\r\n    }\r\n\r\n    public setEmpty(bool:boolean,playTween:boolean = false,col_row:number = 1){\r\n        this._isEmpty = bool;\r\n        if(!bool){\r\n            if(this._itemEntity){\r\n                this.clearTween();\r\n                this._itemEntity.active = true;\r\n            }\r\n            else{\r\n                this.initUI();\r\n            }\r\n        }\r\n        else{\r\n            if(this._itemEntity){\r\n                if(playTween){\r\n                    if(!this._playTween){\r\n                        this._playTween = true;\r\n                        let index:number = col_row == 1? this._row : this._col;\r\n                        TweenManager.addTween(this._itemEntity.transform2D).wait(0.05 * index).to({scaleX:2,scaleY:2},0.05).to({scaleX:0,scaleY:0},0.1);\r\n                    }\r\n                }\r\n                else{\r\n                    this.clearTween();\r\n                    this._itemEntity.active = false;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private clearTween(){\r\n        if(this._playTween){\r\n            TweenManager.removeTweens(this._itemEntity.transform2D);\r\n            this._itemEntity.transform2D.scaleX = 1;\r\n            this._itemEntity.transform2D.scaleY = 1;\r\n            this._playTween = false;\r\n        }\r\n    }\r\n\r\n    public get position():number[] {\r\n        return this._posArr;\r\n    }\r\n\r\n    public get col():number{\r\n        return this._col;\r\n    }\r\n\r\n    public get row():number{\r\n        return this._row;\r\n    }\r\n\r\n    public getItemWorldPos():engine.Vector2{\r\n        if(!this._itemEntity){\r\n            return null;\r\n        }\r\n        return this._itemEntity.transform2D.worldPosition;\r\n    }\r\n}\r\n\r\nclass BtnPreviewGrid {\r\n    private _touchMask:engine.Entity;\r\n    private _preview:engine.Entity;\r\n    private _previewX:number;//初始X位置\r\n    private _previewY:number;//初始Y位置\r\n    private _moveStartX:number;\r\n    private _moveStartY:number;\r\n    private _offsetX:number;\r\n    private _offsetY:number;\r\n    private _canMove:boolean;\r\n    private _gridIndex:number;\r\n\r\n    private _randomGrid:engine.Entity;\r\n    private _lastRandomGrid:engine.Entity;\r\n    private _gridList:engine.Entity[];\r\n    private _btnGrid:engine.UIButton;\r\n    public onAwake() {\r\n        this.initUI();        \r\n    }\r\n    public onUpdate(dt) {\r\n\r\n    }\r\n    public onDestroy() {\r\n\r\n    }\r\n\r\n    private initUI(){\r\n        this._preview = GameUI.FindChild(this.entity,\"preview\");\r\n        this._previewX = this._preview.transform2D.positionX;\r\n        this._previewY = this._preview.transform2D.positionY;\r\n        \r\n\r\n        this._btnGrid = GameUI.FindChild(this.entity,\"btnGrid\",engine.UIButton);\r\n        this._btnGrid.onTouchCancel.add(function(){\r\n            self.touchEnd();\r\n        });\r\n        this._btnGrid.onTouchUp.add(function(){\r\n            self.touchEnd();\r\n        });\r\n        let self = this;\r\n        this._btnGrid.onTouchStart.add(function(target:any,event:any){\r\n            let touches = event.touches[0];\r\n            self.touchStart(touches.position.x,touches.position.y);\r\n            \r\n        });\r\n        this._btnGrid.onTouchMove.add(function(target:any,event:any){\r\n            let touches = event.touches[0];\r\n            self.touchMove(touches.position.x,touches.position.y);\r\n        });\r\n        \r\n        this._touchMask = GameUI.FindChild(this.entity,\"touchMask\");\r\n        this._touchMask.active = false;\r\n\r\n        this.updatePreviewGrid();\r\n    }\r\n\r\n    private touchStart(startX:number,startY:number){\r\n        if(this._canMove) return;\r\n        this._moveStartX = startX;\r\n        this._moveStartY = startY + 200;\r\n        this._offsetX = startX;\r\n        this._offsetY = startY;\r\n        let self = this;\r\n        self._canMove = true;\r\n        TweenManager.removeTweens(this._preview.transform2D);\r\n        TweenManager.addTween(this._preview.transform2D).to({scaleX:2, scaleY:2, positionX:this._moveStartX, positionY:this._moveStartY},0.1);\r\n        Mgr.soundMgr.play(\"crrect_answer1\",false);\r\n    }\r\n\r\n    private touchMove(moveX:number,moveY:number){\r\n        if(this._canMove){\r\n            let offsetX = moveX - this._offsetX;\r\n            let offsetY = moveY - this._offsetY;\r\n            this._preview.transform2D.positionX = this._moveStartX + offsetX;\r\n            this._preview.transform2D.positionY = this._moveStartY + offsetY;\r\n        }\r\n    }\r\n\r\n    private touchEnd(){\r\n        if(this._canMove){\r\n            this._canMove = false;\r\n            EventManager.dispatch(EventEnum.OnGameGridTouchEnd,this._gridIndex,this._gridList);\r\n        }\r\n    }\r\n\r\n    public UpdateTouchEndResult(isRight:boolean,itemList:MapGridItem[]){\r\n        if(isRight){\r\n            this._touchMask.active = true;\r\n            Mgr.soundMgr.play(\"crrect_answer2\",false);\r\n            let self = this;\r\n            for(let i = 0; i < itemList.length; i++){\r\n                let item:MapGridItem = itemList[i];\r\n                let localPos:engine.Vector2 = this._randomGrid.transform2D.convertWorldPositionToLocal(item.getItemWorldPos());\r\n                let grid:engine.Entity = this._gridList[i];//GameUI.FindChild(this._randomGrid,\"grid\" + (i+1));\r\n                TweenManager.addTween(grid.transform2D).to({positionX:localPos.x,positionY:localPos.y},0.1).call(function(){\r\n                    grid.active = false;\r\n                });\r\n            }\r\n        }else{\r\n            // Mgr.soundMgr.play(\"error999\");\r\n            Mgr.soundMgr.play(\"mobile_phone_O\",false);\r\n            TweenManager.removeTweens(this._preview.transform2D);\r\n            TweenManager.addTween(this._preview.transform2D).to({scaleX:1,scaleY:1,positionX:this._previewX,positionY:this._previewY},0.1);\r\n        }\r\n    }\r\n\r\n    public set gridIndex(index:number) {\r\n        this._gridIndex = index;\r\n    }\r\n\r\n    public get gridIndex():number {\r\n        return this._gridIndex;\r\n    }\r\n\r\n    public updatePreviewGrid(){\r\n        this._touchMask.active = false;\r\n        this._preview.transform2D.positionX = this._previewX;\r\n        this._preview.transform2D.positionY = this._previewY;\r\n        this._preview.transform2D.scaleX = 1;\r\n        this._preview.transform2D.scaleY = 1;\r\n        let gridIdx:number = 1 + Math.round(Math.random() * 9);\r\n        let url:string = \"Resources/Prefabs/PreviewGrid\" + gridIdx + \".prefab\";\r\n        if(engine.loader.getAsset(url)){\r\n            this.updatePreview(url);\r\n        }else{\r\n            let self = this;\r\n            engine.loader.load(url).promise.then((prefabAsset:engine.Prefab) => {\r\n                self.updatePreview(url);\r\n            })\r\n        }\r\n    }\r\n\r\n    private updatePreview(url:string) {\r\n        let prefabAsset:engine.Prefab = engine.loader.getAsset(url);\r\n        let entity:engine.Entity;\r\n        if(prefabAsset){\r\n            if(this._lastRandomGrid){\r\n                this._lastRandomGrid.destroyImmediate();\r\n                this._lastRandomGrid = null;\r\n            }\r\n            if(this._randomGrid){\r\n                //保存上一个格子对象，用于完成3个的缓动效果\r\n                this._lastRandomGrid = this._randomGrid;\r\n                this._randomGrid.active = false;//隐藏上一个，否则会影响下一个格子的布局位置\r\n            }\r\n            entity = prefabAsset.instantiate();\r\n            this._preview.transform2D.addChild(entity.transform2D);\r\n            this._randomGrid = entity;\r\n            let num = entity.transform2D.childrenCount;\r\n            this._gridList = [];\r\n            for(let i = 1; i <= num; i++){\r\n                let grid:engine.Entity = GameUI.FindChild(entity,\"grid\" + i);\r\n                this._gridList.push(grid);\r\n            }\r\n            if(Math.random() > 0.5){\r\n                entity.transform2D.rotation = 90 * Math.PI / 180;\r\n            }\r\n            if(Math.random() > 0.5){\r\n                entity.transform2D.scaleX = -1;\r\n            }\r\n            if(Math.random() > 0.5){\r\n                entity.transform2D.scaleY = -1;\r\n            }\r\n        }\r\n        else{\r\n            console.log(\"找不到资源\");\r\n        }\r\n    }\r\n}\r\n"]}