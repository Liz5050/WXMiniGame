{"version":3,"sources":["file:///G:/Work/cocoscreator/svn/MiniGame/assets/script/game/gameGrid/view/GameGridStartView.ts"],"names":["MapGridItem","BtnPreviewGrid","_decorator","Button","Component","instantiate","Label","math","Node","NodeEventType","resources","EventManager","EventEnum","TweenManager","Mgr","GameType","WXSDK","ccclass","property","GameGridStartView","_btns","_txtScore","_mapItemList","_mapContainer","_rightCount","_score","_removeCount","_endCheckLocalPos","update","dt","start","node","getChildByPath","i","idx","btn","getChildByName","gridIndex","push","getComponent","string","btnExit","self","on","EventType","CLICK","uploadScore","exitClear","dispatch","OnGameExit","Grid","initMapGrid","addListener","OnGameGridTouchEnd","OnTouchEndCheck","OnGameGridReqNextPreview","OnReqNextPreview","onDisable","soundMgr","stopBGM","value","String","Date","order","KVData","key","postMessage","type","row","col","item","init","length","updatePreviewGrid","index","gridList","Vec3","num","emptyNum","itemArr","grid","inverseTransformPoint","worldPosition","x","y","ConvertXYToIndex","isEmpty","checkListX","checkListY","setEmpty","indexOf","ShowRight","ShowError","splice","canRemove","lenX","lenY","totalNum","score","play","posX","posY","Math","round","abs","OnGameStart","active","k","_col","_row","_posX","_posY","_itemEntity","_container","_posArr","_isEmpty","_playTween","consturctor","container","initUI","url","prefabAsset","get","addChild","setPosition","bool","playTween","col_row","clearTween","addTween","wait","to","scaleX","scaleY","removeTweens","setScale","position","getItemWorldPos","getWorldPosition","constructor","_touchMask","_preview","_previewPos","_previewScale","_previewX","_previewY","_moveStartX","_moveStartY","_canMove","_gridIndex","_randomGrid","_lastRandomGrid","_gridList","_btnGrid","_node","getPosition","getScale","TOUCH_CANCEL","touchEnd","TOUCH_END","pos1","pos2","TOUCH_START","event","uiPos","getUIStartLocation","touchStart","TOUCH_MOVE","pos","getUIDelta","touchMove","startX","startY","deltaX","deltaY","itemList","localPos","call","gridIdx","random","updatePreview","load","destroy","children","angle","console","log"],"mappings":"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","sourcesContent":["import { _decorator, Button, Component, EventTouch, instantiate, Label, math, Node, NodeEventType, Prefab, resources, sys} from 'cc';\r\nimport { EventManager } from '../../../manager/EventManager';\r\nimport { EventEnum } from '../../../enum/EventEnum';\r\nimport TweenManager from '../../../common/TweenManager';\r\nimport Mgr from '../../../manager/Mgr';\r\nimport { GameType } from '../../../enum/GameType';\r\nimport WXSDK from '../../../SDK/WXSDK';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameGridStartView')\r\nexport class GameGridStartView extends Component {\r\n    private _btns:BtnPreviewGrid[];\r\n\r\n    private _txtScore:Label;\r\n\r\n    private _mapItemList:MapGridItem[][];\r\n    private _mapContainer:Node;\r\n    private _rightCount:number = 0;\r\n    private _score:number = 0;\r\n    private _removeCount:number = 0;//连消计数\r\n    public update(dt) {\r\n\r\n    }\r\n    public start(): void {\r\n        this._mapContainer = this.node.getChildByPath(\"gridMap/items\");\r\n\r\n        this._btns = [];\r\n        for(let i = 0; i < 3; i++){\r\n            let idx = i + 1;\r\n            let btn = new BtnPreviewGrid(this.node.getChildByName(\"BtnPreviewGrid\" + idx));\r\n            btn.gridIndex = i;\r\n            this._btns.push(btn);\r\n        }\r\n\r\n        this._txtScore = this.node.getChildByName(\"txtScore\").getComponent(Label);\r\n        this._txtScore.string = \"得分：0\";\r\n\r\n        let btnExit:Node = this.node.getChildByName(\"btnExit\");\r\n        let self = this\r\n        btnExit.on(Button.EventType.CLICK,function(){\r\n            //退出前回到初始化状态\r\n            self.uploadScore();\r\n            self.exitClear();\r\n            EventManager.dispatch(EventEnum.OnGameExit,GameType.Grid);\r\n        });\r\n\r\n        this.initMapGrid();\r\n        EventManager.addListener(EventEnum.OnGameGridTouchEnd,this.OnTouchEndCheck,this);\r\n        EventManager.addListener(EventEnum.OnGameGridReqNextPreview,this.OnReqNextPreview,this);\r\n    }\r\n\r\n    public onDisable(): void {\r\n        Mgr.soundMgr.stopBGM();    \r\n    }\r\n\r\n    private uploadScore(){\r\n        let value = {\r\n            \"wxgame\": {\r\n                \"value\": this._score,\r\n                \"update_time\": String(+ new Date() / 1000)\r\n            },\r\n            \"unitStr\":\"分\",\r\n            order:2\r\n        }\r\n        let KVData = { key: \"rank_\" + GameType.Grid, value: value };\r\n        WXSDK.postMessage({type:\"UploadScore\",KVData:KVData});\r\n        // let KVDataList = [KVData];\r\n        // WXSDK.setUserCloudStorage({\r\n        //     KVDataList: KVDataList,\r\n        //     success(res) {\r\n        //         console.log(\"[WxPlatform] 保存用户数据成功:\", KVDataList);\r\n        //     },\r\n        //     fail(res) {\r\n        //         console.log(\"[WxPlatform] 保存用户数据失败:\", KVDataList,res);\r\n        //     }\r\n        // });\r\n    }\r\n\r\n    private initMapGrid(){\r\n        this._mapItemList = [];\r\n        for(let row = 0; row < 10; row++){\r\n            for(let col = 0; col < 10; col++){\r\n                if(!this._mapItemList[row]){\r\n                    this._mapItemList[row] = [];\r\n                }\r\n                let item:MapGridItem = new MapGridItem();\r\n                this._mapItemList[row][col] = item;\r\n                item.init(col,row,this._mapContainer);\r\n            }\r\n        }\r\n    }\r\n\r\n    private OnReqNextPreview(){\r\n        for(let i = 0; i < this._btns.length; i++){\r\n            this._btns[i].updatePreviewGrid();\r\n        }\r\n    }\r\n\r\n    private _endCheckLocalPos:math.Vec3;\r\n    private OnTouchEndCheck(index:number,gridList:Node[]){\r\n        if(!this._endCheckLocalPos){\r\n            this._endCheckLocalPos = new math.Vec3();\r\n        }\r\n        let num = gridList.length;\r\n        let emptyNum = 0;\r\n        let itemArr:MapGridItem[] = [];\r\n        for(let i = 0; i < num; i ++) {\r\n            let grid:Node = gridList[i];//GameUI.FindChild(randomGrid,\"grid\" + i);\r\n            this._mapContainer.inverseTransformPoint(this._endCheckLocalPos,grid.worldPosition);\r\n            // console.log(\"坐标转换\" + i + \"----x：\" + localPos.x + \"----y：\" + localPos.y)\r\n            if(this._endCheckLocalPos.x >= -500 && this._endCheckLocalPos.x <= 500 && this._endCheckLocalPos.y >= -500 && this._endCheckLocalPos.y <= 500){\r\n                //在范围内，进一步检测对应网格是否是空位\r\n                let idx:number[] = this.ConvertXYToIndex(this._endCheckLocalPos.x,this._endCheckLocalPos.y);\r\n                // console.log(\"坐标转换行列值\" + i + \"----col：\" + idx[0] + \"----row：\" + idx[1]);\r\n                let item:MapGridItem = this._mapItemList[idx[1]][idx[0]];\r\n                if(item.isEmpty){\r\n                    emptyNum ++;\r\n                    itemArr.push(item);\r\n                }else{\r\n                    //存在非空网格\r\n                    break;\r\n                }\r\n            }\r\n            else{\r\n                //不在网格地图范围内\r\n                break;\r\n            }\r\n        }\r\n\r\n        let checkListX:number[] = [];\r\n        let checkListY:number[] = [];\r\n        if(emptyNum == num){\r\n            for(let i = 0; i < itemArr.length; i ++){\r\n                itemArr[i].setEmpty(false);\r\n                let col:number = itemArr[i].col;\r\n                let row:number = itemArr[i].row;\r\n                if(checkListX.indexOf(col) == -1){\r\n                    checkListX.push(col);\r\n                }\r\n                if(checkListY.indexOf(row) == -1){\r\n                    checkListY.push(row);\r\n                }\r\n            }\r\n            this._rightCount ++;\r\n            this._btns[index].ShowRight(itemArr);\r\n        }\r\n        else{\r\n            this._btns[index].ShowError();\r\n        }\r\n        if(this._rightCount >= 3){\r\n            this._rightCount = 0;\r\n            this.OnReqNextPreview();\r\n        }\r\n\r\n        for(let i:number = checkListX.length - 1; i >= 0; i--){\r\n            let col:number = checkListX[i];\r\n            for(let row:number = 0; row < 10; row++){\r\n                if(this._mapItemList[row][col].isEmpty){\r\n                    checkListX.splice(i,1);\r\n                    break; \r\n                }\r\n            }\r\n        }\r\n        for(let i:number = checkListY.length - 1; i >= 0 ; i--){\r\n            let row:number = checkListY[i];\r\n            for(let col:number = 0; col < 10; col++){\r\n                if(this._mapItemList[row][col].isEmpty){\r\n                    checkListY.splice(i,1);\r\n                    break; \r\n                }\r\n            }\r\n        }\r\n        let canRemove:boolean = false;\r\n        let lenX:number = checkListX.length;\r\n        let lenY:number = checkListY.length;\r\n        for(let i:number = 0; i < lenX; i++){\r\n            let col:number = checkListX[i];\r\n            for(let row:number = 0; row < 10; row++){\r\n                this._mapItemList[row][col].setEmpty(true,true,1);//1、纵向消除\r\n                canRemove = true\r\n            }\r\n        }\r\n        for(let i:number = 0; i < lenY ; i++){\r\n            let row:number = checkListY[i];\r\n            for(let col:number = 0; col < 10; col++){\r\n                this._mapItemList[row][col].setEmpty(true,true,2);//2、横向消除\r\n                canRemove = true\r\n            }\r\n        }\r\n        if(canRemove) {\r\n            this._removeCount ++;\r\n            let totalNum = lenX + lenY;\r\n            let score:number = 0;\r\n            if(totalNum == 1 || totalNum == 2){\r\n                score = totalNum;\r\n            }\r\n            else if(totalNum == 3){\r\n                score = totalNum + 1;\r\n            }\r\n            else if(totalNum > 3){\r\n                score = totalNum * 2;\r\n            }\r\n            if(this._removeCount > 1){\r\n                //连续消除\r\n                score += this._removeCount * totalNum;\r\n            }\r\n            this._score += score;\r\n            this._txtScore.string = \"得分：\" + this._score;\r\n            Mgr.soundMgr.play(\"crrect_answer3\");//存在可消除的行or列\r\n        }\r\n        else {\r\n            this._removeCount = 0;\r\n        }\r\n    }\r\n\r\n    //局部坐标转换为网格索引\r\n    private ConvertXYToIndex(posX:number,posY:number):number[]{\r\n        let col = Math.round((posX + 450) / 100);\r\n        let row = Math.round(Math.abs(posY - 450) / 100);\r\n        return [col,row];\r\n    }\r\n\r\n    public OnGameStart(){\r\n        this._score = 0;\r\n        this._txtScore.string = \"得分：0\";\r\n        this.OnReqNextPreview();\r\n    }\r\n    private exitClear(){\r\n        this._rightCount = 0;\r\n        this.node.active = false;\r\n        this._txtScore.string = \"得分：0\";\r\n        this._score = 0;\r\n        for(let i:number = 0; i < this._mapItemList.length; i++){\r\n            for(let k:number = 0; k < this._mapItemList[i].length; k++){\r\n                this._mapItemList[i][k].setEmpty(true);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport class MapGridItem {\r\n    private _col:number;\r\n    private _row:number;\r\n    private _posX:number;\r\n    private _posY:number;\r\n    private _itemEntity:Node;\r\n    private _container:Node;\r\n    private _posArr:number[];\r\n\r\n    private _isEmpty:boolean = true;\r\n    private _playTween:boolean;\r\n    public consturctor(){\r\n\r\n    }\r\n\r\n    public init(col:number,row:number,container:Node){\r\n        this._col = col;\r\n        this._row = row;\r\n        this._posX = -450 + col * 100;\r\n        this._posY = 450 - row * 100;\r\n        this._posArr = [this._posX,this._posY];\r\n        this._container = container;\r\n    }\r\n\r\n    private initUI(){\r\n        let url:string = \"prefab/GameGridMapItem\";\r\n        let prefabAsset:Prefab = resources.get(url);\r\n        if(prefabAsset){\r\n            this._itemEntity = instantiate(prefabAsset);\r\n            this._container.addChild(this._itemEntity);\r\n            this._itemEntity.setPosition(this._posX,this._posY);\r\n        }\r\n    }\r\n\r\n    public get isEmpty():boolean{\r\n        return this._isEmpty;\r\n    }\r\n\r\n    public setEmpty(bool:boolean,playTween:boolean = false,col_row:number = 1){\r\n        this._isEmpty = bool;\r\n        if(!bool){\r\n            if(this._itemEntity){\r\n                this.clearTween();\r\n                this._itemEntity.active = true;\r\n            }\r\n            else{\r\n                this.initUI();\r\n            }\r\n        }\r\n        else{\r\n            if(this._itemEntity){\r\n                if(playTween){\r\n                    if(!this._playTween){\r\n                        this._playTween = true;\r\n                        let index:number = col_row == 1? this._row : this._col;\r\n                        TweenManager.addTween(this._itemEntity).wait(50 * index).to({scaleX:2,scaleY:2},50).to({scaleX:0,scaleY:0},100);\r\n                    }\r\n                }\r\n                else{\r\n                    this.clearTween();\r\n                    this._itemEntity.active = false;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private clearTween(){\r\n        if(this._playTween){\r\n            TweenManager.removeTweens(this._itemEntity);\r\n            this._itemEntity.setScale(1,1);\r\n            this._playTween = false;\r\n        }\r\n    }\r\n\r\n    public get position():number[] {\r\n        return this._posArr;\r\n    }\r\n\r\n    public get col():number{\r\n        return this._col;\r\n    }\r\n\r\n    public get row():number{\r\n        return this._row;\r\n    }\r\n\r\n    public getItemWorldPos():math.Vec3{\r\n        if(!this._itemEntity){\r\n            return null;\r\n        }\r\n        \r\n        return this._itemEntity.getWorldPosition();\r\n    }\r\n}\r\n\r\nclass BtnPreviewGrid {\r\n    private _touchMask:Node;\r\n    private _preview:Node;\r\n    private _previewPos:math.Vec3;\r\n    private _previewScale:math.Vec3;\r\n    private _previewX:number;//初始X位置\r\n    private _previewY:number;//初始Y位置\r\n    private _moveStartX:number;\r\n    private _moveStartY:number;\r\n    private _canMove:boolean;\r\n    private _gridIndex:number;\r\n\r\n    private _randomGrid:Node;\r\n    private _lastRandomGrid:Node;\r\n    private _gridList:Node[];\r\n    private _btnGrid:Node;\r\n    private _node:Node;\r\n    public constructor(node:Node) {\r\n        this._node = node;\r\n        this.initUI();        \r\n    }\r\n\r\n    private initUI(){\r\n        this._preview = this._node.getChildByName(\"preview\");\r\n        this._previewPos = this._preview.getPosition();\r\n        this._previewScale = this._preview.getScale();\r\n        this._previewX = this._previewPos.x;\r\n        this._previewY = this._previewPos.y;\r\n        \r\n\r\n        this._btnGrid = this._node.getChildByName(\"btnGrid\")\r\n        this._btnGrid.on(Node.EventType.TOUCH_CANCEL,function(){\r\n            self.touchEnd();\r\n        });\r\n        \r\n        this._btnGrid.on(NodeEventType.TOUCH_END,function(){\r\n            self.touchEnd();\r\n        });\r\n        let self = this;\r\n        let pos1 = new math.Vec3();\r\n        let pos2 = new math.Vec3();\r\n        this._btnGrid.on(NodeEventType.TOUCH_START,function(event:EventTouch){\r\n            let uiPos = event.getUIStartLocation();\r\n            pos2.x = uiPos.x;\r\n            pos2.y = uiPos.y;\r\n            self._node.inverseTransformPoint(pos1,pos2);\r\n            self.touchStart(pos1.x,pos1.y);\r\n        });\r\n\r\n        this._btnGrid.on(NodeEventType.TOUCH_MOVE,function(event:EventTouch){\r\n            let pos = event.getUIDelta();\r\n            self.touchMove(pos.x,pos.y);\r\n        });\r\n        \r\n        this._touchMask = this._node.getChildByName(\"touchMask\");\r\n        this._touchMask.active = false;\r\n\r\n        this.updatePreviewGrid();\r\n    }\r\n\r\n    private touchStart(startX:number,startY:number){\r\n        if(this._canMove) return;\r\n        this._moveStartX = startX;\r\n        this._moveStartY = startY + 300;\r\n        // this._offsetX = startX;\r\n        // this._offsetY = startY;\r\n        let self = this;\r\n        self._canMove = true;\r\n        TweenManager.removeTweens(this._preview);\r\n        TweenManager.addTween(this._preview).to({scaleX:2, scaleY:2,x:this._moveStartX,y:this._moveStartY},100);\r\n        Mgr.soundMgr.play(\"crrect_answer1\",false);\r\n    }\r\n\r\n    private touchMove(deltaX:number,deltaY:number){\r\n        if(this._canMove){\r\n            // let offsetX = moveX - this._offsetX;\r\n            // let offsetY = moveY - this._offsetY;\r\n            let posX = this._moveStartX + deltaX;\r\n            let posY = this._moveStartY + deltaY;\r\n            this._moveStartX = posX;\r\n            this._moveStartY = posY;\r\n            this._preview.setPosition(posX,posY);\r\n        }\r\n    }\r\n\r\n    private touchEnd(){\r\n        if(this._canMove){\r\n            this._canMove = false;\r\n            EventManager.dispatch(EventEnum.OnGameGridTouchEnd,this._gridIndex,this._gridList);\r\n        }\r\n    }\r\n\r\n    public ShowRight(itemList:MapGridItem[]){\r\n        this._touchMask.active = true;\r\n        Mgr.soundMgr.play(\"crrect_answer2\",false);\r\n        let self = this;\r\n        for(let i = 0; i < itemList.length; i++){\r\n            let item:MapGridItem = itemList[i];\r\n            let localPos:math.Vec3 = new math.Vec3();\r\n            this._randomGrid.inverseTransformPoint(localPos,item.getItemWorldPos());\r\n\r\n            let grid:Node = this._gridList[i];\r\n            TweenManager.addTween(grid).to({x:localPos.x,y:localPos.y},100).call(function(){\r\n                grid.active = false;\r\n            });\r\n        }\r\n    }\r\n\r\n    public ShowError(){\r\n        // Mgr.soundMgr.play(\"error999\");\r\n        Mgr.soundMgr.play(\"mobile_phone_O\",false);\r\n        TweenManager.removeTweens(this._preview);\r\n        TweenManager.addTween(this._preview).to({x:this._previewX, y:this._previewY,scaleX:1,scaleY:1},100);\r\n    }\r\n\r\n    public set gridIndex(index:number) {\r\n        this._gridIndex = index;\r\n    }\r\n\r\n    public get gridIndex():number {\r\n        return this._gridIndex;\r\n    }\r\n\r\n    public updatePreviewGrid(){\r\n        this._touchMask.active = false;\r\n        this._preview.setPosition(this._previewX,this._previewY);\r\n        this._preview.setScale(1,1);\r\n        let gridIdx:number = 1 + Math.round(Math.random() * 9);\r\n        let url:string = \"prefab/PreviewGrid\" + gridIdx;\r\n        if(resources.get(url)){\r\n            this.updatePreview(url);\r\n        }else{\r\n            let self = this;\r\n            resources.load(url,function(){\r\n                self.updatePreview(url);\r\n            });\r\n        }\r\n    }\r\n\r\n    private updatePreview(url:string) {\r\n        let prefabAsset:Prefab = resources.get(url);\r\n        let node:Node;\r\n        if(prefabAsset){\r\n            if(this._lastRandomGrid){\r\n                this._lastRandomGrid.destroy();\r\n                this._lastRandomGrid = null;\r\n            }\r\n            if(this._randomGrid){\r\n                //保存上一个格子对象，用于完成3个的缓动效果\r\n                this._lastRandomGrid = this._randomGrid;\r\n                this._randomGrid.active = false;//隐藏上一个，否则会影响下一个格子的布局位置\r\n            }\r\n            node = instantiate(prefabAsset);\r\n            this._preview.addChild(node);\r\n            this._randomGrid = node;\r\n            let num = node.children.length;\r\n            this._gridList = [];\r\n            for(let i = 1; i <= num; i++){\r\n                let grid:Node = node.getChildByName(\"grid\" + i);\r\n                this._gridList.push(grid);\r\n            }\r\n            if(Math.random() > 0.5){\r\n                node.angle = 90;// * Math.PI / 180;\r\n            }\r\n            let scaleX = Math.random() > 0.5 ? -1 : 1;\r\n            let scaleY = Math.random() > 0.5 ? -1 : 1;\r\n            node.setScale(scaleX,scaleY);\r\n        }\r\n        else{\r\n            console.log(\"找不到资源\");\r\n        }\r\n    }\r\n}\r\n"]}